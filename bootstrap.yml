# Initial configuration so we can start using a new server.

# Once this is done, there will be some users with no passwords, ECDSA
# keys (copied locally to ./keys), and sudo access. sshd will be
# configured to only accept key logins.

- hosts: IAD
  user: root
  vars:
    new_users: [lvh, ansible]

  tasks:
    - name: Create users
      user:
        name={{ item }}
        generate_ssh_key=yes
        ssh_key_type=ecdsa ssh_key_bits=521 # Not a typo, I mean 521.
      with_items: new_users

    - name: fetch new pubkeys
      fetch:
        src=/home/{{ item }}/.ssh/id_ecdsa.pub
        dest=./keys
      with_items: new_users

    - name: Update sshd_config
      template: src=./sshd_config.j2
        dest=/etc/ssh/sshd_config
        backup=yes
        owner=0 group=0 mode=0644
        validate='/usr/sbin/sshd -T -f %s'
      notify:
        - restart sshd

    - name: Disable root password
      command: passwd --lock root

  handlers:
    - name: restart sshd
      service: name=sshd state=restarted
